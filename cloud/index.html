<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartHome Cloud - Login</title>
    <meta name="description" content="Control your ESP32 Smart Home from anywhere in the world">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>Loading SmartHome Cloud...</p>
    </div>

    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">
                <span class="icon">≡ƒÅá</span>
                <h1>SmartHome Cloud</h1>
                <p>Control your home from anywhere</p>
            </div>

            <div id="errorMsg" class="error-msg"></div>
            <div id="successMsg" class="success-msg"></div>

            <!-- Tabs -->
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchTab('login')">Login</button>
                <button class="auth-tab" onclick="switchTab('register')">Register</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required
                        autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" id="loginBtn">≡ƒöæ Login to Dashboard</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="regEmail" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="regPassword" placeholder="Min 6 characters" required minlength="6">
                </div>

                <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border);">
                <p style="color: var(--text-muted); margin-bottom: 15px; font-size: 0.9em;">Device Setup</p>

                <div class="form-group">
                    <label>Device ID</label>
                    <input type="text" id="regDeviceId" placeholder="e.g. SH-001 (Must match ESP32)" required>
                </div>
                <div class="form-group">
                    <label>Device Name</label>
                    <input type="text" id="regDeviceName" placeholder="e.g. My Home" required>
                </div>
                <button type="submit" class="btn btn-primary" id="registerBtn">≡ƒô▒ Register & Create Account</button>
            </form>
        </div>
    </div>

    <!-- Config & Logic -->
    <script src="config.js"></script>
    <script src="app.js"></script>
    <script>
        // Check if already logged in
        const token = localStorage.getItem('access_token');
        if (token) {
            window.location.href = 'dashboard.html';
        } else {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function switchTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

            if (tab === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
            clearMessages();
        }

        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.textContent = 'ΓÅ│ Logging in...';
            clearMessages();

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            try {
                // 1. Get Token
                const formData = new URLSearchParams();
                formData.append('username', email);
                formData.append('password', password);

                const response = await fetch(`${API_URL}/login/access-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Login failed');
                }

                const data = await response.json();
                localStorage.setItem('access_token', data.access_token);

                // Redirect
                window.location.href = 'dashboard.html';

            } catch (err) {
                showError(err.message);
                btn.disabled = false;
                btn.textContent = '≡ƒöæ Login to Dashboard';
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const btn = document.getElementById('registerBtn');
            btn.disabled = true;
            btn.textContent = 'ΓÅ│ Registering...';
            clearMessages();

            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const deviceId = document.getElementById('regDeviceId').value.trim();
            const deviceName = document.getElementById('regDeviceName').value.trim();

            try {
                // 1. Create User
                let res = await fetch(`${API_URL}/users/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'User registration failed');
                }

                // 2. Login to get Token (to register device)
                const formData = new URLSearchParams();
                formData.append('username', email);
                formData.append('password', password);

                res = await fetch(`${API_URL}/login/access-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (!res.ok) throw new Error('Auto-login failed after registration');
                const tokenData = await res.json();
                const token = tokenData.access_token;
                localStorage.setItem('access_token', token);

                // 3. Register Device
                res = await fetch(`${API_URL}/devices/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        id: deviceId,
                        name: deviceName,
                        type: 'esp32'
                    })
                });

                if (!res.ok) {
                    const err = await res.json();
                    // If device fails, usually means ID taken, but user is created.
                    // Let them proceed to dashboard but show warning? Or fail?
                    // For now, throw and let them try again (maybe just login + register device in dashboard).
                    throw new Error(err.detail || 'Device registration failed');
                }

                showSuccess('Γ£à Account & Device Created! Redirecting...');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1500);

            } catch (err) {
                showError(err.message);
                btn.disabled = false;
                btn.textContent = '≡ƒô▒ Register & Create Account';
            }
        }
    </script>
</body>

</html>
