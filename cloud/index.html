<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartHome Cloud - Login</title>
    <meta name="description" content="Control your ESP32 Smart Home from anywhere in the world">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <script>
        // Immediate check to prevent flash
        const token = localStorage.getItem('access_token');
        if (token) {
            window.location.href = 'dashboard.html';
        }
    </script>
    <style>
        /* Hide body until we confirm not logged in */
        body {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            if (!localStorage.getItem('access_token')) {
                document.body.style.visibility = "visible";
                document.body.style.opacity = "1";
            }
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'));
        }
    </script>

    <script>
        function switchTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

            if (tab === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
            clearMessages();
        }

        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.textContent = 'â³ Logging in...';
            clearMessages();

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            try {
                // 1. Get Token
                const formData = new URLSearchParams();
                formData.append('username', email);
                formData.append('password', password);

                const response = await fetch(`${API_URL}/login/access-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Login failed');
                }

                const data = await response.json();
                localStorage.setItem('access_token', data.access_token);

                // Redirect
                window.location.href = 'dashboard.html';

            } catch (err) {
                showError(err.message);
                btn.disabled = false;
                btn.textContent = 'ðŸ”‘ Login to Dashboard';
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const btn = document.getElementById('registerBtn');
            btn.disabled = true;
            btn.textContent = 'â³ Registering...';
            clearMessages();

            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const deviceId = document.getElementById('regDeviceId').value.trim();
            const deviceName = document.getElementById('regDeviceName').value.trim();

            try {
                // 1. Create User
                let res = await fetch(`${API_URL}/users/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'User registration failed');
                }

                // 2. Login to get Token (to register device)
                const formData = new URLSearchParams();
                formData.append('username', email);
                formData.append('password', password);

                res = await fetch(`${API_URL}/login/access-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (!res.ok) throw new Error('Auto-login failed after registration');
                const tokenData = await res.json();
                const token = tokenData.access_token;
                localStorage.setItem('access_token', token);

                // 3. Register Device
                res = await fetch(`${API_URL}/devices/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        id: deviceId,
                        name: deviceName,
                        type: 'esp32'
                    })
                });

                if (!res.ok) {
                    const err = await res.json();
                    // If device fails, usually means ID taken, but user is created.
                    // Let them proceed to dashboard but show warning? Or fail?
                    // For now, throw and let them try again (maybe just login + register device in dashboard).
                    throw new Error(err.detail || 'Device registration failed');
                }

                showSuccess('âœ… Account & Device Created! Redirecting...');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1500);

            } catch (err) {
                showError(err.message);
                btn.disabled = false;
                btn.textContent = 'ðŸ“± Register & Create Account';
            }
        }
    </script>
</body>

</html>