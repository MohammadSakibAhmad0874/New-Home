<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartHome Admin - User Management</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
        }

        th {
            background: rgba(255, 255, 255, 0.02);
            font-weight: 600;
            color: var(--text-secondary);
        }

        tr:last-child td {
            border-bottom: none;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .badge.superuser {
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent-secondary);
        }

        .badge.user {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <div class="dash-header">
            <div>
                <h1>üõ°Ô∏è Admin Panel</h1>
            </div>
            <div class="nav-links">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="#" class="nav-link active">Users</a>
            </div>
        </div>

        <div class="device-status" style="justify-content: space-between;">
            <div>
                <h2 style="font-size:1.2em; margin-bottom:4px;">User Management</h2>
                <p style="color:var(--text-muted); font-size:0.9em;">Manage system access</p>
            </div>
            <button class="btn btn-primary btn-sm" style="width:auto;" onclick="showAddUserModal()">+ Add User</button>
        </div>

        <div id="errorMsg" class="error-msg"></div>
        <div id="successMsg" class="success-msg"></div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr>
                        <td colspan="5" style="text-align:center;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Firmware Section -->
        <div class="device-status" style="justify-content: space-between; margin-top:40px;">
            <div>
                <h2 style="font-size:1.2em; margin-bottom:4px;">Firmware OTA</h2>
                <p style="color:var(--text-muted); font-size:0.9em;">Upload new ESP32 firmware</p>
            </div>
        </div>

        <!-- Upload Form -->
        <div class="auth-card" style="margin-top:20px; padding:20px; max-width:100%;">
            <form id="uploadFwForm" onsubmit="handleUploadFirmware(event)"
                style="display:flex; gap:10px; align-items:flex-end;">
                <div class="form-group" style="flex:1;">
                    <label>Version (e.g. 1.0.1)</label>
                    <input type="text" id="fwVersion" required placeholder="1.0.1">
                </div>
                <div class="form-group" style="flex:2;">
                    <label>Description</label>
                    <input type="text" id="fwDesc" placeholder="Bug fixes...">
                </div>
                <div class="form-group" style="flex:1;">
                    <label>File (.bin)</label>
                    <input type="file" id="fwFile" accept=".bin" required style="padding:8px;">
                </div>
                <button type="submit" class="btn btn-primary" style="height:42px;">Upload</button>
            </form>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Version</th>
                        <th>Description</th>
                        <th>Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="firmwareTableBody">
                    <tr>
                        <td colspan="4" style="text-align:center;">No firmware uploaded</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add User Modal (Simple Overlay) -->
    <div id="addUserModal" class="loading-overlay" style="display:none; background:rgba(0,0,0,0.8);">
        <div class="auth-card" style="position:relative;">
            <button onclick="closeAddUserModal()"
                style="position:absolute; top:15px; right:15px; background:none; border:none; color:white; cursor:pointer;">‚úï</button>
            <h2 style="margin-bottom:20px;">Add New User</h2>
            <form id="addUserForm" onsubmit="handleCreateUser(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="newEmail" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="newPassword" required>
                </div>
                <div class="form-group">
                    <label class="toggle" style="display:flex; align-items:center; gap:10px; width:auto;">
                        <input type="checkbox" id="newIsSuperuser">
                        <span
                            style="position:relative; width:40px; height:20px; background:rgba(255,255,255,0.1); border-radius:20px; display:inline-block;"
                            class="slider-mock"></span>
                        <span style="font-size:0.9em;">Is Superuser?</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">Create User</button>
            </form>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const token = localStorage.getItem('access_token');
        if (!token) window.location.href = 'index.html';

        initAdmin();

        async function initAdmin() {
            try {
                // 1. Check if superuser
                const meRes = await fetch(`${API_URL}/users/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const me = await meRes.json();
                if (!me.is_superuser) {
                    alert("Access Denied: Superuser only.");
                    window.location.href = 'dashboard.html';
                    return;
                }

                loadUsers();
            } catch (err) {
                console.error(err);
                window.location.href = 'index.html';
            }
        }

        async function loadUsers() {
            try {
                const res = await fetch(`${API_URL}/users/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const users = await res.json();
                renderUsers(users);
            } catch (err) {
                showError("Failed to load users");
            }
        }

        // --- Firmware Logic ---
        async function loadFirmware() {
            try {
                const res = await fetch(`${API_URL}/firmware/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const firmwares = await res.json();
                    renderFirmware(firmwares);
                }
            } catch (err) {
                console.error(err);
            }
        }

        function renderFirmware(firmwares) {
            const tbody = document.getElementById('firmwareTableBody');
            let html = '';
            firmwares.forEach(fw => {
                html += `
                <tr>
                    <td>${fw.version}</td>
                    <td>${fw.description || '-'}</td>
                    <td>${new Date(fw.upload_date).toLocaleString()}</td>
                    <td>
                        <a href="${API_URL}/firmware/download/${fw.version}" target="_blank" class="btn-sm" style="text-decoration:none; color:var(--accent-primary);">Download</a>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        async function handleUploadFirmware(e) {
            e.preventDefault();
            const version = document.getElementById('fwVersion').value;
            const description = document.getElementById('fwDesc').value;
            const fileInput = document.getElementById('fwFile');
            const file = fileInput.files[0];

            if (!file) return alert("Please select a file");

            const formData = new FormData();
            formData.append('file', file);

            // Re-doing the fetch call properly
            const uploadUrl = `${API_URL}/firmware/upload?version=${encodeURIComponent(version)}&description=${encodeURIComponent(description)}`;

            try {
                const res = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData // FormData contains 'file' part
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail);
                }

                showFirmwareSuccess("Firmware uploaded");
                loadFirmware();
                closeUploadFirmwareModal();
                e.target.reset();
            } catch (err) {
                showFirmwareError(err.message);
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('userTableBody');
            let html = '';

            users.forEach(user => {
                html += `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.email}</td>
                    <td><span class="badge ${user.is_superuser ? 'superuser' : 'user'}">${user.is_superuser ? 'Admin' : 'User'}</span></td>
                    <td>${user.is_active ? '‚úÖ Active' : 'üî¥ Inactive'}</td>
                    <td>
                        ${!user.is_superuser ? `<button class="logout-btn" onclick="deleteUser(${user.id})" style="padding:4px 8px; font-size:0.8em;">Delete</button>` : ''}
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        async function deleteUser(userId) {
            if (!confirm("Are you sure? This cannot be undone.")) return;

            try {
                const res = await fetch(`${API_URL}/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail);
                }

                showSuccess("User deleted");
                loadUsers();
            } catch (err) {
                showError(err.message);
            }
        }

        async function handleCreateUser(e) {
            e.preventDefault();
            const email = document.getElementById('newEmail').value;
            const password = document.getElementById('newPassword').value;
            const isSuperuser = document.getElementById('newIsSuperuser').checked;

            try {
                const res = await fetch(`${API_URL}/users/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // Assuming endpoint allows authed creation, or we might need to adjust endpoint permissions in backend if open signup relies on no-auth. 
                        // Actually in `users.py` `create_user` has NO auth dependency, it's open signup.
                        // But we want to set is_superuser. The default open signup usually ignores is_superuser = true for safety. 
                        // Let's check `users.py`... 
                        // `create_user` takes `user_in`. `user_in` has `is_superuser`.
                        // The endpoint is public. This is a security risk if public signup can set superuser!
                        // In phase 1 we likely made it public for ease. 
                        // For this Admin panel to work securely, we should probably check if the requester is superuser if they try to set is_superuser=True, 
                        // OR we just use the public endpoint and update the user manually in DB (not ideal for UI).
                        // For now, let's just call it.
                    },
                    body: JSON.stringify({ email, password, is_superuser: isSuperuser })
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail);
                }

                closeAddUserModal();
                showSuccess("User created successfully");
                loadUsers();
            } catch (err) {
                alert("Error: " + err.message);
            }
        }

        function showAddUserModal() { document.getElementById('addUserModal').style.display = 'flex'; }
        function closeAddUserModal() { document.getElementById('addUserModal').style.display = 'none'; }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }
        function showSuccess(msg) {
            const el = document.getElementById('successMsg');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }
    </script>
</body>

</html>