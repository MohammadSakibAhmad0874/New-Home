<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeControl â€“ Super Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0f;
            --bg2: #111118;
            --bg3: #1a1a26;
            --border: rgba(255, 255, 255, 0.07);
            --accent: #7c3aed;
            --accent2: #06b6d4;
            --accent3: #10b981;
            --danger: #ef4444;
            --warn: #f59e0b;
            --text: #f1f5f9;
            --muted: #64748b;
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* â”€â”€ SIDEBAR â”€â”€ */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 240px;
            height: 100vh;
            background: var(--bg2);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px 0;
            z-index: 100;
        }

        .logo {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .logo h2 {
            font-size: 1em;
            font-weight: 700;
        }

        .logo span {
            font-size: 0.65em;
            color: var(--accent2);
            font-weight: 600;
            letter-spacing: 1px;
        }

        .nav {
            flex: 1;
            padding: 20px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: var(--radius);
            cursor: pointer;
            color: var(--muted);
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .nav-item:hover {
            background: var(--bg3);
            color: var(--text);
        }

        .nav-item.active {
            background: rgba(124, 58, 237, 0.15);
            color: var(--accent);
        }

        .nav-item .icon {
            font-size: 1.1em;
            min-width: 20px;
        }

        .sidebar-footer {
            padding: 16px 12px;
            border-top: 1px solid var(--border);
        }

        .admin-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: var(--radius);
            border: 1px solid rgba(124, 58, 237, 0.2);
        }

        .admin-badge .av {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: 700;
        }

        .admin-badge .info {
            flex: 1;
            min-width: 0;
        }

        .admin-badge .name {
            font-size: 0.8em;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .admin-badge .role {
            font-size: 0.7em;
            color: var(--accent2);
            font-weight: 600;
        }

        /* â”€â”€ MAIN â”€â”€ */
        .main {
            margin-left: 240px;
            min-height: 100vh;
        }

        .topbar {
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .topbar h1 {
            font-size: 1.1em;
            font-weight: 700;
        }

        .topbar-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .content {
            padding: 32px;
        }

        /* â”€â”€ STAT CARDS â”€â”€ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
        }

        .stat-icon.purple {
            background: rgba(124, 58, 237, 0.15);
        }

        .stat-icon.cyan {
            background: rgba(6, 182, 212, 0.15);
        }

        .stat-icon.green {
            background: rgba(16, 185, 129, 0.15);
        }

        .stat-icon.amber {
            background: rgba(245, 158, 11, 0.15);
        }

        .stat-val {
            font-size: 1.8em;
            font-weight: 800;
            line-height: 1;
        }

        .stat-lbl {
            font-size: 0.8em;
            color: var(--muted);
            margin-top: 4px;
        }

        /* â”€â”€ SECTION â”€â”€ */
        .section {
            margin-bottom: 32px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 1.05em;
            font-weight: 700;
        }

        .section-sub {
            font-size: 0.8em;
            color: var(--muted);
            margin-top: 2px;
        }

        /* â”€â”€ TABLE â”€â”€ */
        .table-wrap {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--bg3);
            padding: 12px 16px;
            text-align: left;
            font-size: 0.78em;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9em;
            vertical-align: middle;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .empty-row td {
            text-align: center;
            color: var(--muted);
            padding: 40px;
        }

        /* â”€â”€ BADGES â”€â”€ */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .badge.online {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent3);
        }

        .badge.offline {
            background: rgba(100, 116, 139, 0.15);
            color: var(--muted);
        }

        .badge.admin {
            background: rgba(124, 58, 237, 0.2);
            color: #a78bfa;
        }

        .badge.user {
            background: rgba(255, 255, 255, 0.07);
            color: var(--muted);
        }

        .badge.active {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent3);
        }

        .badge.inactive {
            background: rgba(239, 68, 68, 0.15);
            color: #fca5a5;
        }

        /* â”€â”€ BUTTONS â”€â”€ */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #6d28d9;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .btn-ghost {
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
        }

        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.78em;
        }

        .btn-icon {
            padding: 6px;
            border-radius: 8px;
        }

        /* â”€â”€ RELAY TOGGLE â”€â”€ */
        .relay-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .relay-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 0.78em;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .relay-btn.on {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent3);
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .relay-btn.off {
            background: rgba(100, 116, 139, 0.15);
            color: var(--muted);
            border: 1px solid var(--border);
        }

        .relay-btn:hover {
            transform: scale(1.05);
        }

        .relay-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
        }

        .relay-dot.on {
            background: var(--accent3);
            box-shadow: 0 0 6px var(--accent3);
        }

        .relay-dot.off {
            background: var(--muted);
        }

        /* â”€â”€ TOAST â”€â”€ */
        #toast {
            position: fixed;
            bottom: 32px;
            right: 32px;
            padding: 12px 20px;
            border-radius: var(--radius);
            font-size: 0.9em;
            font-weight: 500;
            display: none;
            animation: slideUp 0.3s ease;
            z-index: 9999;
        }

        #toast.success {
            background: rgba(16, 185, 129, 0.9);
            color: white;
        }

        #toast.error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* â”€â”€ MODAL â”€â”€ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
            width: 100%;
            max-width: 440px;
            position: relative;
        }

        .modal h3 {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 1.2em;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--text);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 0.82em;
            font-weight: 500;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.9em;
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--accent);
        }

        /* â”€â”€ TABS â”€â”€ */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            padding: 4px;
            background: var(--bg2);
            border-radius: 10px;
            width: fit-content;
            border: 1px solid var(--border);
        }

        .tab {
            padding: 7px 18px;
            border-radius: 7px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            color: var(--muted);
            border: none;
            background: none;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--accent);
            color: white;
        }

        /* â”€â”€ SECTION PANELS â”€â”€ */
        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* â”€â”€ SEARCH â”€â”€ */
        .search-input {
            padding: 8px 14px;
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.85em;
            outline: none;
            width: 220px;
        }

        .search-input:focus {
            border-color: var(--accent);
        }

        /* â”€â”€ LOGIN SCREEN â”€â”€ */
        #loginScreen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-card {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            width: 380px;
            text-align: center;
        }

        .login-card .big-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            margin: 0 auto 20px;
        }

        .login-card h2 {
            font-size: 1.4em;
            font-weight: 800;
            margin-bottom: 6px;
        }

        .login-card p {
            color: var(--muted);
            font-size: 0.85em;
            margin-bottom: 28px;
        }

        .login-err {
            color: #ef4444;
            font-size: 0.82em;
            margin-top: 8px;
            display: none;
        }

        /* scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg3);
            border-radius: 3px;
        }

        @media (max-width: 900px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .main {
                margin-left: 0;
            }
        }
    </style>
</head>

<body>

    <!-- â•â•â•â•â•â•â•â•â•â•â• LOGIN SCREEN â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="loginScreen">
        <div class="login-card">
            <div class="big-icon">ğŸ›¡ï¸</div>
            <h2>Admin Access</h2>
            <p>HomeControl Super Admin Panel</p>
            <div class="form-group" style="text-align:left">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="admin@email.com" value="ahmadsakib263@gmail.com">
            </div>
            <div class="form-group" style="text-align:left">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value="MrNoor@874">
            </div>
            <button class="btn btn-primary" style="width:100%;justify-content:center;padding:12px;"
                onclick="doLogin()">Sign In</button>
            <div id="loginErr" class="login-err">âŒ Invalid credentials or not an admin account</div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <div class="logo-icon">ğŸ </div>
            <div>
                <h2>HomeControl</h2>
                <span>ADMIN PANEL</span>
            </div>
        </div>
        <nav class="nav">
            <button class="nav-item active" onclick="showPanel('overview')">
                <span class="icon">ğŸ“Š</span> Overview
            </button>
            <button class="nav-item" onclick="showPanel('devices')">
                <span class="icon">ğŸ“¡</span> All Devices
            </button>
            <button class="nav-item" onclick="showPanel('users')">
                <span class="icon">ğŸ‘¥</span> Users
            </button>
            <button class="nav-item" onclick="showPanel('firmware')">
                <span class="icon">âš¡</span> Firmware OTA
            </button>
            <hr style="border-color: var(--border); margin: 8px 14px;">
            <a href="dashboard.html" class="nav-item" style="text-decoration:none;">
                <span class="icon">ğŸ </span> User Dashboard
            </a>
        </nav>
        <div class="sidebar-footer">
            <div class="admin-badge">
                <div class="av">SA</div>
                <div class="info">
                    <div class="name" id="adminEmail">Admin</div>
                    <div class="role">SUPERUSER</div>
                </div>
                <button onclick="logout()" title="Logout"
                    style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.1em;">â†©</button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â• MAIN CONTENT â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="main">
        <div class="topbar">
            <h1 id="panelTitle">ğŸ“Š Overview</h1>
            <div class="topbar-right">
                <span style="font-size:0.8em;color:var(--muted);" id="lastRefresh"></span>
                <button class="btn btn-ghost btn-sm" onclick="refreshAll()">â†º Refresh</button>
            </div>
        </div>

        <div class="content">
            <!-- â”€â”€ TOAST â”€â”€ -->
            <div id="toast"></div>

            <!-- â•â•â•â•â•â•â•â• OVERVIEW PANEL â•â•â•â•â•â•â•â• -->
            <div class="panel active" id="panel-overview">
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-icon purple">ğŸ‘¥</div>
                        <div>
                            <div class="stat-val" id="statUsers">â€”</div>
                            <div class="stat-lbl">Total Users</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon cyan">ğŸ“¡</div>
                        <div>
                            <div class="stat-val" id="statDevices">â€”</div>
                            <div class="stat-lbl">Total Devices</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">ğŸŸ¢</div>
                        <div>
                            <div class="stat-val" id="statOnline">â€”</div>
                            <div class="stat-lbl">Online Now</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon amber">ğŸ›¡ï¸</div>
                        <div>
                            <div class="stat-val" id="statAdmins">â€”</div>
                            <div class="stat-lbl">Superusers</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <div>
                            <div class="section-title">Recent Devices</div>
                            <div class="section-sub">All registered devices across all users</div>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showPanel('devices')">View All â†’</button>
                    </div>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Device ID</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Owner ID</th>
                                    <th>Status</th>
                                    <th>Last Seen</th>
                                    <th>Controls</th>
                                </tr>
                            </thead>
                            <tbody id="overviewDeviceTable">
                                <tr class="empty-row">
                                    <td colspan="7">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â• DEVICES PANEL â•â•â•â•â•â•â•â• -->
            <div class="panel" id="panel-devices">
                <div class="section">
                    <div class="section-header">
                        <div>
                            <div class="section-title">All Devices</div>
                            <div class="section-sub">View, control, edit and delete every registered device</div>
                        </div>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <input type="text" class="search-input" placeholder="ğŸ” Search devices..."
                                oninput="filterDevices(this.value)">
                            <button class="btn btn-primary btn-sm" onclick="openAddDeviceModal()">+ Add Device</button>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Device ID</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Owner ID</th>
                                    <th>IP</th>
                                    <th>Status</th>
                                    <th>API Key</th>
                                    <th>Relays</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="devicesTable">
                                <tr class="empty-row">
                                    <td colspan="9">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â• USERS PANEL â•â•â•â•â•â•â•â• -->
            <div class="panel" id="panel-users">
                <div class="section">
                    <div class="section-header">
                        <div>
                            <div class="section-title">User Management</div>
                            <div class="section-sub">View, promote, and delete user accounts</div>
                        </div>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <input type="text" class="search-input" placeholder="ğŸ” Search users..."
                                oninput="filterUsers(this.value)">
                            <button class="btn btn-primary btn-sm" onclick="openAddUserModal()">+ Add User</button>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <tr class="empty-row">
                                    <td colspan="5">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â• FIRMWARE PANEL â•â•â•â•â•â•â•â• -->
            <div class="panel" id="panel-firmware">
                <div class="section">
                    <div class="section-header">
                        <div>
                            <div class="section-title">Firmware OTA</div>
                            <div class="section-sub">Upload and manage ESP32 firmware versions</div>
                        </div>
                    </div>
                    <div class="table-wrap" style="padding:24px;margin-bottom:24px;">
                        <form id="fwForm" onsubmit="uploadFirmware(event)"
                            style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;">
                            <div class="form-group" style="flex:1;min-width:120px;margin:0">
                                <label>Version</label>
                                <input type="text" id="fwVer" placeholder="1.0.2" required>
                            </div>
                            <div class="form-group" style="flex:2;min-width:180px;margin:0">
                                <label>Description</label>
                                <input type="text" id="fwDesc" placeholder="Bug fixes...">
                            </div>
                            <div class="form-group" style="flex:1;min-width:150px;margin:0">
                                <label>Binary (.bin)</label>
                                <input type="file" id="fwFile" accept=".bin" required style="padding:8px;">
                            </div>
                            <button type="submit" class="btn btn-primary">Upload â†‘</button>
                        </form>
                    </div>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Version</th>
                                    <th>Description</th>
                                    <th>Upload Date</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="fwTable">
                                <tr class="empty-row">
                                    <td colspan="4">No firmware uploaded</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â• -->

    <!-- Rename Device Modal -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('renameModal')">âœ•</button>
            <h3>âœï¸ Rename Device</h3>
            <input type="hidden" id="renameDeviceId">
            <div class="form-group">
                <label>New Name</label>
                <input type="text" id="renameDeviceName" placeholder="Living Room Hub">
            </div>
            <button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="submitRename()">Save
                Name</button>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal-overlay" id="addUserModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('addUserModal')">âœ•</button>
            <h3>â• Add New User</h3>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="newUserEmail" placeholder="user@example.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="newUserPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <div class="form-group">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                    <input type="checkbox" id="newUserAdmin"> Make Superuser (Admin)
                </label>
            </div>
            <button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="submitAddUser()">Create
                User</button>
        </div>
    </div>

    <!-- Add Device Modal -->
    <div class="modal-overlay" id="addDeviceModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('addDeviceModal')">âœ•</button>
            <h3>â• Register New Device</h3>
            <div class="form-group">
                <label>Device ID (e.g. esp32-001)</label>
                <input type="text" id="newDevId" placeholder="esp32-001">
            </div>
            <div class="form-group">
                <label>Device Name</label>
                <input type="text" id="newDevName" placeholder="Living Room Hub">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="newDevType">
                    <option value="esp32">ESP32</option>
                    <option value="esp8266">ESP8266</option>
                    <option value="generic">Generic</option>
                </select>
            </div>
            <button class="btn btn-primary" style="width:100%;justify-content:center;"
                onclick="submitAddDevice()">Register Device</button>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal" style="max-width:360px;text-align:center;">
            <div style="font-size:2.5em;margin-bottom:12px;">âš ï¸</div>
            <h3 id="confirmTitle">Are you sure?</h3>
            <p id="confirmMsg" style="color:var(--muted);font-size:0.9em;margin:12px 0 24px;"></p>
            <div style="display:flex;gap:10px;justify-content:center;">
                <button class="btn btn-ghost" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="btn btn-danger" id="confirmBtn">Delete</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let TOKEN = localStorage.getItem('access_token') || '';
        let allDevices = [];
        let allUsers = [];

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTH
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function doLogin() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPassword').value;
            const errEl = document.getElementById('loginErr');
            errEl.style.display = 'none';

            try {
                const form = new URLSearchParams();
                form.append('username', email);
                form.append('password', pass);

                const res = await fetch(`${API_URL}/auth/login/access-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: form
                });

                if (!res.ok) throw new Error('Bad credentials');
                const data = await res.json();
                TOKEN = data.access_token;

                // Verify superuser
                const meRes = await fetch(`${API_URL}/users/me`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const me = await meRes.json();
                if (!me.is_superuser) {
                    errEl.textContent = 'âŒ This account does not have admin privileges.';
                    errEl.style.display = 'block';
                    return;
                }

                localStorage.setItem('access_token', TOKEN);
                document.getElementById('adminEmail').textContent = me.email;
                document.getElementById('loginScreen').style.display = 'none';
                refreshAll();

            } catch (e) {
                errEl.textContent = 'âŒ Invalid credentials or not an admin account';
                errEl.style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            window.location.reload();
        }

        // If already logged in, skip login screen
        window.addEventListener('DOMContentLoaded', async () => {
            if (!TOKEN) return;
            try {
                const res = await fetch(`${API_URL}/users/me`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const me = await res.json();
                if (!me.is_superuser) { TOKEN = ''; localStorage.removeItem('access_token'); return; }
                document.getElementById('adminEmail').textContent = me.email;
                document.getElementById('loginScreen').style.display = 'none';
                refreshAll();
            } catch {
                TOKEN = '';
                localStorage.removeItem('access_token');
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NAVIGATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const panels = ['overview', 'devices', 'users', 'firmware'];
        const panelTitles = {
            overview: 'ğŸ“Š Overview',
            devices: 'ğŸ“¡ All Devices',
            users: 'ğŸ‘¥ Users',
            firmware: 'âš¡ Firmware OTA'
        };

        function showPanel(name) {
            panels.forEach(p => {
                document.getElementById(`panel-${p}`).classList.toggle('active', p === name);
            });
            document.querySelectorAll('.nav-item').forEach((el, i) => {
                el.classList.toggle('active', el.textContent.trim().includes(panelTitles[panels[i]]?.split(' ')[1] || '##'));
            });
            // simpler active nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navMap = { overview: 0, devices: 1, users: 2, firmware: 3 };
            const navItems = document.querySelectorAll('.nav-item');
            if (navMap[name] !== undefined) navItems[navMap[name]].classList.add('active');
            document.getElementById('panelTitle').textContent = panelTitles[name];
            // Load data on demand
            if (name === 'devices') loadDevices();
            if (name === 'users') loadUsers();
            if (name === 'firmware') loadFirmware();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DATA LOADING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function refreshAll() {
            document.getElementById('lastRefresh').textContent = 'Refreshed: ' + new Date().toLocaleTimeString();
            await Promise.all([loadDevices(), loadUsers(), loadFirmware()]);
            updateStats();
        }

        async function loadDevices() {
            try {
                const r = await fetch(`${API_URL}/devices/admin/all`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                if (!r.ok) throw new Error('API error');
                allDevices = await r.json();
                renderDevices(allDevices);
                renderOverviewDevices(allDevices.slice(0, 8));
                updateStats();
            } catch (e) {
                document.getElementById('devicesTable').innerHTML = `<tr class="empty-row"><td colspan="9">âš ï¸ Failed to load devices</td></tr>`;
            }
        }

        async function loadUsers() {
            try {
                const r = await fetch(`${API_URL}/users/`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                if (!r.ok) throw new Error();
                allUsers = await r.json();
                renderUsers(allUsers);
                updateStats();
            } catch {
                document.getElementById('usersTable').innerHTML = `<tr class="empty-row"><td colspan="5">âš ï¸ Failed to load users</td></tr>`;
            }
        }

        async function loadFirmware() {
            try {
                const r = await fetch(`${API_URL}/firmware/`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                if (!r.ok) throw new Error();
                const fw = await r.json();
                const tbody = document.getElementById('fwTable');
                if (!fw.length) {
                    tbody.innerHTML = `<tr class="empty-row"><td colspan="4">No firmware uploaded yet</td></tr>`;
                    return;
                }
                tbody.innerHTML = fw.map(f => `
            <tr>
                <td><strong>v${f.version}</strong></td>
                <td>${f.description || 'â€”'}</td>
                <td>${new Date(f.upload_date).toLocaleString()}</td>
                <td>
                    <a href="${API_URL}/firmware/download/${f.version}" target="_blank" class="btn btn-ghost btn-sm" style="text-decoration:none;">â¬‡ï¸ Download</a>
                </td>
            </tr>`).join('');
            } catch { }
        }

        function updateStats() {
            document.getElementById('statUsers').textContent = allUsers.length || 'â€”';
            document.getElementById('statDevices').textContent = allDevices.length || 'â€”';
            document.getElementById('statOnline').textContent = allDevices.filter(d => d.online).length;
            document.getElementById('statAdmins').textContent = allUsers.filter(u => u.is_superuser).length;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RENDER DEVICES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderOverviewDevices(devs) {
            const tb = document.getElementById('overviewDeviceTable');
            if (!devs.length) { tb.innerHTML = `<tr class="empty-row"><td colspan="7">No devices registered</td></tr>`; return; }
            tb.innerHTML = devs.map(d => `
        <tr>
            <td><code style="font-size:0.85em;color:var(--accent2);">${d.id}</code></td>
            <td><strong>${d.name}</strong></td>
            <td><span style="color:var(--muted);font-size:0.85em;">${d.type || 'esp32'}</span></td>
            <td><span style="color:var(--muted);">#${d.owner_id}</span></td>
            <td>${statusBadge(d.online)}</td>
            <td style="color:var(--muted);font-size:0.82em;">${d.last_seen ? new Date(d.last_seen).toLocaleString() : 'â€”'}</td>
            <td>${relayControls(d)}</td>
        </tr>`).join('');
        }

        function renderDevices(devs) {
            const tb = document.getElementById('devicesTable');
            if (!devs.length) { tb.innerHTML = `<tr class="empty-row"><td colspan="9">No devices found</td></tr>`; return; }
            tb.innerHTML = devs.map(d => `
        <tr id="dev-row-${d.id}">
            <td><code style="font-size:0.82em;color:var(--accent2);">${d.id}</code></td>
            <td><strong>${d.name}</strong></td>
            <td><span style="color:var(--muted);font-size:0.85em;">${d.type || 'esp32'}</span></td>
            <td><span style="color:var(--muted);">#${d.owner_id}</span></td>
            <td style="font-size:0.8em;color:var(--muted);">${d.ip_address || 'â€”'}</td>
            <td>${statusBadge(d.online)}</td>
            <td>
                <code style="font-size:0.7em;color:var(--muted);" title="${d.api_key}">${d.api_key ? d.api_key.slice(0, 12) + 'â€¦' : 'â€”'}</code>
                <button onclick="copyText('${d.api_key}')" class="btn btn-ghost btn-sm btn-icon" title="Copy API Key">ğŸ“‹</button>
            </td>
            <td>${relayControls(d)}</td>
            <td>
                <div style="display:flex;gap:6px;flex-wrap:wrap;">
                    <button class="btn btn-ghost btn-sm" onclick="openRenameModal('${d.id}','${escHtml(d.name)}')">âœï¸</button>
                    <button class="btn btn-danger btn-sm" onclick="confirmDeleteDevice('${d.id}','${escHtml(d.name)}')">ğŸ—‘ï¸</button>
                </div>
            </td>
        </tr>`).join('');
        }

        function relayControls(device) {
            const state = device.start_state || {};
            const relays = Object.keys(state);
            if (!relays.length) return `<span style="color:var(--muted);font-size:0.8em;">No relays</span>`;
            return `<div class="relay-row">${relays.map(k => {
                const on = state[k]?.state === true || state[k]?.state === 1;
                return `<button class="relay-btn ${on ? 'on' : 'off'}" onclick="toggleRelay('${device.id}','${k}',${!on})" title="${k}">
            <div class="relay-dot ${on ? 'on' : 'off'}"></div>${k}
        </button>`;
            }).join('')}</div>`;
        }

        function statusBadge(online) {
            return online
                ? `<span class="badge online">ğŸŸ¢ Online</span>`
                : `<span class="badge offline">âš« Offline</span>`;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RENDER USERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderUsers(users) {
            const tb = document.getElementById('usersTable');
            if (!users.length) { tb.innerHTML = `<tr class="empty-row"><td colspan="5">No users found</td></tr>`; return; }
            tb.innerHTML = users.map(u => `
        <tr>
            <td style="color:var(--muted);">#${u.id}</td>
            <td>
                <strong>${u.email}</strong>
                ${u.email === 'ahmadsakib263@gmail.com' ? ' <span style="font-size:0.7em;color:var(--accent2);">YOU</span>' : ''}
            </td>
            <td>
                <span class="badge ${u.is_superuser ? 'admin' : 'user'}">${u.is_superuser ? 'ğŸ›¡ï¸ Admin' : 'ğŸ‘¤ User'}</span>
            </td>
            <td>
                <span class="badge ${u.is_active ? 'active' : 'inactive'}">${u.is_active ? 'âœ… Active' : 'ğŸ”´ Inactive'}</span>
            </td>
            <td>
                <div style="display:flex;gap:6px;flex-wrap:wrap;">
                    ${!u.is_superuser ? `<button class="btn btn-danger btn-sm" onclick="confirmDeleteUser(${u.id},'${escHtml(u.email)}')">ğŸ—‘ï¸ Delete</button>` : `<span style="color:var(--muted);font-size:0.8em;">Protected</span>`}
                </div>
            </td>
        </tr>`).join('');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SEARCH FILTER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function filterDevices(q) {
            const filtered = allDevices.filter(d =>
                d.id.toLowerCase().includes(q.toLowerCase()) ||
                d.name.toLowerCase().includes(q.toLowerCase())
            );
            renderDevices(filtered);
        }
        function filterUsers(q) {
            const filtered = allUsers.filter(u => u.email.toLowerCase().includes(q.toLowerCase()));
            renderUsers(filtered);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RELAY CONTROL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function toggleRelay(deviceId, relayKey, newState) {
            try {
                const action = newState ? 'on' : 'off';
                const r = await fetch(`${API_URL}/devices/${deviceId}/relays/${relayKey}/${action}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                if (!r.ok) throw new Error();
                toast(`${relayKey} turned ${action.toUpperCase()}`, 'success');
                setTimeout(() => loadDevices(), 500);
            } catch {
                toast('Failed to toggle relay', 'error');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DEVICE ACTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function openRenameModal(id, name) {
            document.getElementById('renameDeviceId').value = id;
            document.getElementById('renameDeviceName').value = name;
            openModal('renameModal');
        }

        async function submitRename() {
            const id = document.getElementById('renameDeviceId').value;
            const name = document.getElementById('renameDeviceName').value.trim();
            if (!name) return;
            try {
                const r = await fetch(`${API_URL}/devices/admin/${id}/rename`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${TOKEN}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (!r.ok) throw new Error();
                closeModal('renameModal');
                toast('Device renamed successfully!', 'success');
                loadDevices();
            } catch {
                toast('Failed to rename device', 'error');
            }
        }

        function confirmDeleteDevice(id, name) {
            document.getElementById('confirmTitle').textContent = 'Delete Device?';
            document.getElementById('confirmMsg').textContent = `Are you sure you want to delete "${name}" (${id})? This cannot be undone.`;
            document.getElementById('confirmBtn').onclick = () => deleteDevice(id);
            openModal('confirmModal');
        }

        async function deleteDevice(id) {
            try {
                const r = await fetch(`${API_URL}/devices/admin/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                if (!r.ok) throw new Error();
                closeModal('confirmModal');
                toast('Device deleted', 'success');
                loadDevices();
            } catch {
                toast('Failed to delete device', 'error');
            }
        }

        function openAddDeviceModal() { openModal('addDeviceModal'); }

        async function submitAddDevice() {
            const id = document.getElementById('newDevId').value.trim();
            const name = document.getElementById('newDevName').value.trim();
            const type = document.getElementById('newDevType').value;
            if (!id || !name) return toast('Fill all fields', 'error');
            try {
                const r = await fetch(`${API_URL}/devices/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${TOKEN}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, name, type })
                });
                if (!r.ok) { const e = await r.json(); throw new Error(e.detail); }
                closeModal('addDeviceModal');
                toast('Device registered!', 'success');
                loadDevices();
            } catch (e) {
                toast('Error: ' + e.message, 'error');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // USER ACTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function openAddUserModal() { openModal('addUserModal'); }

        async function submitAddUser() {
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPass').value;
            const is_superuser = document.getElementById('newUserAdmin').checked;
            try {
                const r = await fetch(`${API_URL}/users/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, is_superuser })
                });
                if (!r.ok) { const e = await r.json(); throw new Error(e.detail); }
                closeModal('addUserModal');
                toast('User created!', 'success');
                loadUsers();
            } catch (e) {
                toast('Error: ' + e.message, 'error');
            }
        }

        function confirmDeleteUser(id, email) {
            document.getElementById('confirmTitle').textContent = 'Delete User?';
            document.getElementById('confirmMsg').textContent = `Delete "${email}"? All their devices will also be inaccessible.`;
            document.getElementById('confirmBtn').onclick = () => deleteUser(id);
            openModal('confirmModal');
        }

        async function deleteUser(id) {
            try {
                const r = await fetch(`${API_URL}/users/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                if (!r.ok) throw new Error();
                closeModal('confirmModal');
                toast('User deleted', 'success');
                loadUsers();
            } catch {
                toast('Failed to delete user', 'error');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FIRMWARE UPLOAD
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function uploadFirmware(e) {
            e.preventDefault();
            const ver = document.getElementById('fwVer').value;
            const desc = document.getElementById('fwDesc').value;
            const file = document.getElementById('fwFile').files[0];
            if (!file) return toast('Select a .bin file', 'error');
            const fd = new FormData();
            fd.append('file', file);
            try {
                const r = await fetch(`${API_URL}/firmware/upload?version=${encodeURIComponent(ver)}&description=${encodeURIComponent(desc)}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${TOKEN}` },
                    body: fd
                });
                if (!r.ok) throw new Error();
                toast('Firmware uploaded!', 'success');
                e.target.reset();
                loadFirmware();
            } catch {
                toast('Firmware upload failed', 'error');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UTILS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        function toast(msg, type = 'success') {
            const el = document.getElementById('toast');
            el.textContent = (type === 'success' ? 'âœ… ' : 'âŒ ') + msg;
            el.className = type;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        function copyText(txt) {
            navigator.clipboard.writeText(txt);
            toast('Copied to clipboard!', 'success');
        }

        function escHtml(str) {
            return String(str).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        // Close modals on outside click
        document.querySelectorAll('.modal-overlay').forEach(el => {
            el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
        });

        // Enter key on login
        document.addEventListener('keydown', e => {
            if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
                doLogin();
            }
        });
    </script>
</body>

</html>