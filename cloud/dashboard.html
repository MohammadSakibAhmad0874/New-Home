<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartHome - Dashboard</title>
    <meta name="description" content="Control your ESP32 Smart Home switches from anywhere">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>Loading devices...</p>
    </div>

    <div class="dashboard" id="mainDashboard" style="display:none;">
        <!-- Header -->
        <div class="dash-header">
            <h1>🏠 SmartHome</h1>
            <div class="nav-links">
                <a href="dashboard.html" class="nav-link active">Dashboard</a>
                <a href="settings.html" class="nav-link">Settings</a>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- User info -->
        <div class="user-badge" style="margin-bottom:16px;">
            <span>👤 <span id="userName">User</span></span>
            <span style="color:var(--text-muted);">|</span>
            <span>📟 Device: <strong id="userDeviceId">—</strong></span>
        </div>

        <!-- Device status -->
        <div class="device-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText" style="font-weight:600;">Connecting...</span>
            <span class="device-id-label" id="lastSeenLabel" style="margin-left:auto;"></span>
        </div>

        <!-- Switch Controls -->
        <div class="controls-grid" id="controlsGrid">
            <!-- Dynamically populated -->
        </div>

        <!-- ESP32 Setup Info -->
        <div
            style="background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-top:10px;">
            <h3 style="margin-bottom:12px;font-size:1em;color:var(--text-secondary);">⚙️ ESP32 Setup</h3>
            <p style="color:var(--text-muted);font-size:0.85em;line-height:1.6;">
                Your ESP32 must be connected to WiFi and configured with Device ID:
                <strong id="setupDeviceId" style="color:var(--accent-blue);"></strong><br>
                Update <code
                    style="background:rgba(255,255,255,0.06);padding:2px 6px;border-radius:4px;">config.h</code> and
                <code
                    style="background:rgba(255,255,255,0.06);padding:2px 6px;border-radius:4px;">websocketSync.h</code>
                on your ESP32.
            </p>
        </div>
    </div>

    <!-- Config & Logic -->
    <script src="config.js"></script>
    <script src="app.js"></script>
    <script>
        // Icon map using simple emoji — works on all Android browsers
        const switchIcons = ['💡', '🛏️', '🍳', '🌀', '🔌', '💡', '🔌', '🔌'];
        let currentDevice = null;
        let ws = null;
        const token = localStorage.getItem('access_token');

        if (!token) {
            window.location.href = 'index.html';
        }

        initDashboard();

        async function initDashboard() {
            try {
                // 1. Get User Info
                const userRes = await fetch(`${API_URL}/users/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!userRes.ok) throw new Error('Auth failed');
                const user = await userRes.json();
                document.getElementById('userName').textContent = user.email;

                // 2. Get Devices
                const devRes = await fetch(`${API_URL}/devices/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const devices = await devRes.json();

                if (devices.length === 0) {
                    showError('No devices found. Please add one in Settings.');
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('mainDashboard').style.display = 'block';
                    return;
                }

                currentDevice = devices[0];
                document.getElementById('userDeviceId').textContent = currentDevice.id;
                document.getElementById('setupDeviceId').textContent = currentDevice.id;

                renderDevice(currentDevice);
                connectWebSocket(currentDevice.id);

                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';

            } catch (err) {
                console.error(err);
                if (err.message === 'Auth failed') logout();
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
            }
        }

        function connectWebSocket(deviceId) {
            ws = new WebSocket(`${WS_URL}/${deviceId}`);

            ws.onopen = () => {
                console.log('WS Connected');
                updateStatus(true);
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'update') {
                    if (!currentDevice.start_state) currentDevice.start_state = {};
                    Object.assign(currentDevice.start_state, msg.data);
                    renderDevice(currentDevice);
                }
            };

            ws.onclose = () => {
                console.log('WS Disconnected');
                updateStatus(false);
                setTimeout(() => connectWebSocket(deviceId), 3000);
            };
        }

        function updateStatus(online) {
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            if (online) {
                dot.className = 'status-dot online';
                txt.textContent = 'ESP32 Connected';
                txt.style.color = 'var(--accent-green)';
            } else {
                dot.className = 'status-dot offline';
                txt.textContent = 'Disconnected (reconnecting...)';
                txt.style.color = 'var(--accent-red)';
            }
        }

        function renderDevice(device) {
            const grid = document.getElementById('controlsGrid');
            const relays = device.start_state || {};

            if (Object.keys(relays).length === 0) {
                relays.relay1 = { state: false, name: 'Living Room' };
                relays.relay2 = { state: false, name: 'Bedroom' };
                relays.relay3 = { state: false, name: 'Kitchen' };
                relays.relay4 = { state: false, name: 'Fan' };
            }

            let html = '';
            Object.keys(relays).sort().forEach((key, idx) => {
                const relay = relays[key];
                const isOn = relay.state === true;
                const name = relay.name || 'Switch ' + (idx + 1);
                const icon = switchIcons[idx] || '🔌';

                html += `
                <div class="switch-card ${isOn ? 'switch-on' : ''}" onclick="toggleRelay('${device.id}', '${key}', ${isOn})">
                    <div class="switch-info">
                        <span class="switch-icon">${icon}</span>
                        <div>
                            <div class="switch-name">${name}</div>
                            <div class="switch-status ${isOn ? 'status-on' : ''}">${isOn ? '⚡ ON' : 'OFF'}</div>
                        </div>
                    </div>
                    <label class="toggle" onclick="event.stopPropagation()">
                        <input type="checkbox" ${isOn ? 'checked' : ''}
                               onchange="toggleRelay('${device.id}', '${key}', ${isOn})">
                        <span class="toggle-slider"></span>
                    </label>
                </div>`;
            });

            grid.innerHTML = html;
        }

        async function toggleRelay(deviceId, key, currentState) {
            const newState = !currentState;
            if (currentDevice.start_state && currentDevice.start_state[key]) {
                currentDevice.start_state[key].state = newState;
                renderDevice(currentDevice);
            }

            try {
                const update = {};
                update[key] = { state: newState };

                await fetch(`${API_URL}/devices/${deviceId}/state`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(update)
                });
            } catch (e) {
                console.error('Toggle failed', e);
                if (currentDevice.start_state && currentDevice.start_state[key]) {
                    currentDevice.start_state[key].state = currentState;
                    renderDevice(currentDevice);
                }
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            window.location.href = 'index.html';
        }

        function showError(msg) {
            const grid = document.getElementById('controlsGrid');
            grid.innerHTML = `<div style="padding:20px;text-align:center;color:var(--accent-red);">⚠️ ${msg}</div>`;
        }
    </script>
</body>

</html>